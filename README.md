# Power Streamlit Data Processing

This repository contains a comprehensive data processing solution for power sector data analysis.

## Files Overview

### Main Application
- `app_new.py` - Main Streamlit dashboard application

### Data Processing
- `combined_data_processor.py` - **NEW**: Combined script that replaces the following 5 individual scripts:
  - ~~`scrape_price.py`~~ - Price data scraping
  - ~~`scrape_volume.py`~~ - Volume data scraping  
  - ~~`scrape_type.py`~~ - Renewable energy type data scraping
  - ~~`scrape_water.py`~~ - Water reservoir data scraping
  - ~~`match.py`~~ - Data matching and weighted average calculation

### Data Files
- `power_volume.csv` - Monthly power volume data
- `gia_bien_data.csv` - Price data (generated by scraper)
- `phutai_data.csv` - Volume data (generated by scraper)
- `thong_so_vh.csv` - Renewable energy data (generated by scraper)
- `water_reservoir.csv` - Water reservoir data (generated by scraper)
- `weighted_average_prices.csv` - Processed weighted averages (generated by matcher)
- `thermal_price.xlsx` - Thermal price data

## Recent Enhancements ‚ú®

### 1. UI/Chart Improvements
- **Removed secondary y-axis gridlines** from all dual-axis charts for cleaner visualization
- **Enhanced chart readability** by keeping secondary axes but removing their grid overlays

### 2. Growth Calculation Improvements
- **Fixed YoY Growth**: Now only calculates when sufficient historical data exists (prevents incorrect 0% for first year)
- **Improved YTD Growth**: Properly calculates from cumulative values since beginning of year
- **Smart Data Validation**: Growth calculations handle edge cases and missing data gracefully

### 3. Water Capacity Chart Enhancement
- **Added YoY Growth Line** to the water capacity comparison chart
- **Dual-axis visualization** showing both capacity bars and growth percentage line
- **Interactive tooltips** for both capacity and growth metrics

### 4. Download Functionality
- **Excel Export**: Download charts data as `.xlsx` files with proper formatting
- **CSV Export**: Download charts data as `.csv` files for further analysis
- **Timestamped Files**: Auto-generated filenames with timestamp to avoid conflicts
- **Available on All Charts**: Every chart now has download options

### 5. Enhanced Data Processing
- **Improved Error Handling**: Better validation of numeric data and date parsing
- **Smart Growth Calculations**: Uses custom functions for accurate YoY and YTD calculations
- **Data Quality Checks**: Validates data integrity before calculations

## Bug Fixes Applied

### 1. TypeError: unsupported operand type(s) for /: 'str' and 'str'

**Problem**: The CSV data contained string values with commas and spaces (e.g., " 6,097 ") which caused pandas to treat numeric columns as strings, leading to division errors during pct_change() calculations.

**Solution**: Added data cleaning in the `load_data()` function:
```python
# Clean numeric columns - remove commas and spaces, convert to numeric
numeric_columns = ['Hydro', 'Coals', 'Gas', 'Renewables', 'Import & Diesel']
for col in numeric_columns:
    if col in df.columns:
        # Remove spaces and commas, then convert to numeric
        df[col] = df[col].astype(str).str.replace(',', '').str.strip()
        df[col] = pd.to_numeric(df[col], errors='coerce')
```

### 2. Enhanced Growth Calculation
Added proper handling of NaN values in growth calculations:
```python
# Ensure Total column is numeric and handle NaN values
filtered_df['Total'] = pd.to_numeric(filtered_df['Total'], errors='coerce')

# Custom functions for accurate growth calculations
def calculate_yoy_growth(df, value_col, periods):
    """Calculate YoY growth only when sufficient historical data exists"""
    growth = df[value_col].pct_change(periods=periods) * 100
    if len(df) > periods:
        growth.iloc[:periods] = None
    else:
        growth[:] = None
    return growth

def calculate_ytd_growth(df, value_col, date_col, period_type):
    """Calculate proper YTD growth from cumulative values from beginning of year"""
    # Complex logic for proper YTD calculation...
```

## Combined Data Processor Usage

The new `combined_data_processor.py` script replaces all 5 individual scripts and provides a unified interface:

### Command Line Usage
```bash
# Run all scrapers and processing
python combined_data_processor.py --action all

# Run specific components
python combined_data_processor.py --action price
python combined_data_processor.py --action volume
python combined_data_processor.py --action renewable
python combined_data_processor.py --action water
python combined_data_processor.py --action match

# Specify date range
python combined_data_processor.py --action all --start-date 2024-01-01 --end-date 2024-12-31
```

### Features
- **Unified Processing**: All scraping and data processing in one script
- **Async Operations**: Efficient concurrent data fetching
- **Error Handling**: Robust error handling and retry mechanisms
- **Rate Limiting**: Prevents overwhelming target servers
- **Batch Processing**: Processes data in manageable batches
- **Progress Tracking**: Real-time progress updates
- **Flexible Date Ranges**: Configurable start and end dates

### Data Sources
1. **Price Data**: NSMO price API (`GetChartGiaBienVM`)
2. **Volume Data**: NSMO volume API (`GetChartPhuTaiVM`)
3. **Renewable Data**: NSMO renewable energy page (web scraping)
4. **Water Data**: EVN water reservoir page (web scraping)
5. **Weighted Averages**: Calculated from price and volume data

## Running the Application

1. Install dependencies:
```bash
pip install -r requirements.txt
pip install xlsxwriter  # For Excel export functionality
```

2. Run the Streamlit app:
```bash
streamlit run app_new.py
```

3. (Optional) Update data using the combined processor:
```bash
python combined_data_processor.py --action all
```

## Data Flow

1. **Raw Data Collection**: Combined processor scrapes data from multiple sources
2. **Data Cleaning**: Numeric data is cleaned and formatted
3. **Data Matching**: Volume and price data are matched for weighted averages
4. **Visualization**: Streamlit app loads and displays processed data
5. **Export**: Users can download data in Excel or CSV format

## Key Features

### Dashboard Tabs
- **‚ö°Power Volume**: Multi-source power generation analysis with growth metrics
- **üí≤CGM Price**: Market price analysis and trends
- **üçÉRenewable Power**: Solar and wind power generation tracking
- **üíßHydro Power**: Water capacity analysis with YoY growth comparison
- **ü™®Coal-fired Power**: Coal power generation and cost analysis
- **üî•Gas-fired Power**: Gas power generation and cost analysis

### Interactive Controls
- **Period Selection**: Monthly, Quarterly, Semi-annually, Annually
- **Growth Type Selection**: Year-over-Year (YoY) vs Year-to-Date (YTD)
- **Power Type Filtering**: Select specific power sources for analysis
- **Region Selection**: Filter data by geographical regions
- **Year Range Selection**: Focus on specific time periods

### Export Options
- **üìä Excel Download**: Formatted spreadsheets with proper column headers
- **üìÑ CSV Download**: Raw data for further analysis in other tools
- **üïí Timestamp**: Auto-generated filenames prevent overwriting

## Benefits of the Enhanced Approach

- **Cleaner Visualizations**: Removed secondary gridlines for better chart readability
- **Accurate Calculations**: Proper YoY and YTD growth calculation methods
- **Enhanced User Experience**: Download functionality for all charts
- **Better Data Quality**: Improved data validation and error handling
- **Professional Export**: Excel files with proper formatting
- **Reduced Complexity**: Single script instead of 5 separate ones
- **Better Maintainability**: Centralized configuration and error handling
- **Improved Performance**: Optimized async operations and rate limiting
- **Easier Deployment**: Single script to run all data processing
- **Consistent Interface**: Unified command-line interface for all operations
